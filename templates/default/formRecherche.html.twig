<div class="bgcolor w-100 p-1 rounded-4 border border-warning border-2 shadow" xmlns="http://www.w3.org/1999/html"
     xmlns="http://www.w3.org/1999/html">
    <form id="filters">
        <div class="form-row w-100 mb-2">
            <label for="categorie" class="form-label">Cat√©gories</label>
            <select name="categorie"
                    multiple class="form-select unselect-on-null" id="categorie">
                <option value="null" {% if app.request.get('categorie', null) == null %} selected {% endif %}>
                    Tous le site
                </option>
                {% for cat_ in categorie %}
                    <option value="{{ cat_.id }}"
                            {% if cat_.id in app.request.get('categorie', []) %} selected {% endif %}
                    >{{ cat_.name|capitalize }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="row">
            <div class="col-12 col-md-6 mb-3">
                <label for="price_sup" class="form-label">Prix mini</label>
                <input type="number" class="form-control"
                       name="price_sup" value="{{ app.request.get('price_sup', '') }}"
                       id="price_sup" placeholder="99">
            </div>

            <div class="col-12 col-md-6 mb-3">
                <label for="price_inf" class="form-label">Prix max</label>
                <input type="number" class="form-control"
                       name="price_inf" value="{{ app.request.get('price_inf', '') }}"
                       id="price_inf" placeholder="99">
            </div>
        </div>

        <div class="mb-3">
            <label for="query" class="form-label">Recherche</label>
            <input type="text" class="form-control"
                   name="query" value="{{ app.request.get('query', '') }}"
                   id="query" placeholder="meuble occasion...">
            {% if is_granted('ROLE_USER') or is_granted('ROLE_ADMIN')  %}
                <input type="number" name="user" value="{{ app.user.id }}"
                   id="user" hidden>
            {% endif %}
        </div>

        <div class="row">
            <div class="col-12 col-md-6 mb-2">
                <label for="order" class="form-label">Trier par</label>
                <select name="order"
                        class="form-select" id="order">
                    <option value="">Par id</option>
                    <option {% if app.request.get('order', '') == 'produit,asc' %} selected {% endif %}
                        value="produit,asc">Par produit asc</option>
                    <option {% if app.request.get('order', '') == 'produit,desc' %} selected {% endif %}
                        value="produit,desc">Par produit desc</option>
                    <option {% if app.request.get('order', '') == 'price,asc' %} selected {% endif %}
                            value="prix,asc">Du moins cher au plus cher
                    </option>
                    <option {% if app.request.get('order', '') == 'price,desc' %} selected {% endif %}
                            value="prix,desc">Du plus cher au moins cher
                    </option>
                    <option  {% if app.request.get('order', '') == 'date_depot,asc' %} selected {% endif %}
                            value="date_depot,asc">Par date asc
                    </option>
                    <option  {% if app.request.get('order', '') == 'date_depot,desc' %} selected {% endif %}
                            value="date_depot,desc">Par date desc
                    </option>
                </select>
            </div>

            <div class="col-12 col-md-6 mb-2">
                <label for="limit" class="form-label">Nombre annonces par pages</label>
                <select name="limit"
                        class="form-select" id="limit">
                    {% for i in range(1,25) %}
                        <option value="{{ i }}"
                                {% if i == app.request.get('limit', 25) %} selected {% endif %}
                        >{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row">
        <div class="col-4">
            <input type="checkbox" name="imgcheck" id="imgcheck" value="true" {% if app.request.get('imgcheck', '') == 'true' %} checked {% endif %} class="imgcheck m-1">Afficher les annonces avec image...

        </div>
        <div class="col-4">
            {% if is_granted('ROLE_USER') or is_granted('ROLE_ADMIN')  %}
            <input type="checkbox" name="yourcheck" value="true" id="yourcheck" {% if app.request.get('yourcheck', '') == 'true' %} checked {% endif %}  class="yourcheck m-1">Afficher vos annonces...
            {% endif %}
        </div>
{#            <div class="col-4">#}
{#                <input>Afficher vos annonces...</input>#}
{#            </div>#}
        </div>

        <div class="form-row w-100 d-flex justify-content-center align-items-center mt-4">
            <button type="submit" class="subbutt"><p class="Penvoie m-1">Envoyer</p></button>
            <input type="button" class="bg-secondary rounded-circle text-white"
                   id="removeFilters"
                   value="üßπ">
        </div>
    </form>
</div>

<script>
    let selects_ = document.querySelectorAll('select.unselect-on-null');
    selects_.forEach(su_ => {
        su_.addEventListener('change', e => {
            const selected = su_.querySelectorAll('option:checked');
            const values = Array.from(selected).map(el => el.value);
            if (values.includes('null')) {
                su_.querySelectorAll('option').forEach(option => {
                    if (option.value !== 'null') {
                        option.removeAttribute('checked')
                    } else {
                        option.setAttribute('checked', 'true');
                    }
                });
            }
        })
    })
    let removeFilters = document.querySelector('#removeFilters');
    removeFilters.addEventListener('click', e => {
        // redirect to new url
        let baseUrl = '{{ path('app_annonce') }}';
        // get current host
        let host = window.location.host;
        window.location.href = 'https://' + host + baseUrl;
    });
    let form = document.querySelector('#filters');
    form.addEventListener('submit', e => {
        e.preventDefault();
        let payload = {};
        form.querySelectorAll('select').forEach(_select => {
            const name = _select.getAttribute('name');
            let isMultiple = _select.getAttribute('multiple');
            if (isMultiple !== null) {
                const selected = _select.querySelectorAll('option:checked');
                const values = Array.from(selected).map(el => el.value);
                if (Array.isArray(values) && values.length > 0 && !values.includes('null')) {
                    payload[name] = values;
                }
            } else {
                if (_select.value === undefined || _select.value === '') {
                    return;
                }
                payload[name] = _select.value;
            }
        });
        form.querySelectorAll('input').forEach(_input => {
            if (_input.getAttribute('type') === 'submit' || _input.getAttribute('type') === 'button') {
                return;
            }
            const name = _input.getAttribute('name');
            const value = _input.value;

            if (_input.getAttribute('type') === 'checkbox' || _input.getAttribute('type') === 'radio') {
                if (_input.checked) {
                    payload[name] = value;
                }
                return;
            }
            if (value !== undefined && value !== '') {
                payload[name] = value;
            }
        })
        let queryParams = Object.keys(payload).map(key => {
            let v = payload[key];
            if (Array.isArray(v)) {
                let retArray = [];
                for (let i = 0; i < v.length; i++) {
                    let subValue = v[i];
                    retArray.push(key + '[]=' + subValue);
                }
                return retArray.join('&');
            } else {
                return key + '=' + payload[key];
            }
        }).join('&');
        let baseUrl = '{{ path('app_annonce') }}';
        let host = window.location.host;
        window.location.href = 'https://' + host + baseUrl + '?' + queryParams;
    })

</script>
